#!/bin/bash
# Copyright (C) 2014 Julien Bonjean <julien@bonjean.info>
# Copyright (C) 2014 Alexander Keller <github@nycroth.com>

# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.

# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

# The instance option sets the control to report and configure
# This defaults to the first control of your selected mixer
# For a list of the available, use `amixer -D $Your_Mixer scontrols`


#------------------------------------------------------------------------
filename="$HOME/.config/scripts/udisk_index"
ALERT_LOW="${1:-10}" # color will turn red under this value (default: 10%)
INDEX=$(cat ${filename})
init(){
IFS=$'\r\n' 
array_s=($(ls /run/media/hill))
if [ ${#array_s[@]} -eq 0 ] ; then
    exit
else

    df -h -P |grep ${array_s[$INDEX]}|awk -v alert_low=$ALERT_LOW '
 {
        # full text
	print $4

	# short text
	print $4

	use=$5

	# no need to continue parsing
	exit 0
}

END {
	gsub(/%$/,"",use)
	if (100 - use < alert_low) {
		# color
		print "#FF0000"
	}else {print "#A6D1FA"}
}
'
fi
}
# following function will set default to no. $INDEX entry in list generated by aplay -l |grep 'card'
set_default(){
    echo ""
}
#------------------------------------------------------------------------
case $BLOCK_BUTTON in
    1)
        #TODO: left click switch
        INDEX=$((($INDEX +1) % ${#array_s[@]}))
        echo ${array_s[$INDEX]}
        # echo "$INDEX"
        echo "$INDEX" > ${filename}
        ;;
    2)
        #TODO: mid click umount part
        udiskie-umount -D $(df |grep ${array_s[$INDEX]}|awk '{print $1}')
        echo "0" > ${filename}
        init
        ;;
    3) 
        #TODO right click umount disk
        udiskie-umount -d $(df |grep ${array_s[$INDEX]}|awk '{print $1}'|sed 's/[0-9]*$/\*/p')|tail -n 1
        echo "0" > ${filename}
        init
        ;;
    4)
        echo ${array_s[$INDEX]}
        ;;
    5)
        echo ${array_s[$INDEX]}
        ;;

esac
init
